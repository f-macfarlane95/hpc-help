<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mask RCNN &mdash; Crop Diversity HPC Help  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Crop Diversity HPC Help
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="system-overview.html">System Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="user-accounts.html">Requesting an Account</a></li>
<li class="toctree-l1"><a class="reference internal" href="ssh.html">Getting Connected</a></li>
<li class="toctree-l1"><a class="reference internal" href="guest-accounts.html">Guest Accounts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">High performance computing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="slurm-overview.html">Slurm - Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurm-policy.html">Slurm - Queue Policies &amp; Advice</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurm-shortcuts.html">Slurm - Shortcuts and Aliases</a></li>
<li class="toctree-l1"><a class="reference internal" href="bioconda.html">Bioconda</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiling.html">Compiling Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="file-compression.html">Working with Compressed Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="singularity.html">Apptainer (Singularity)</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.html">GPU Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="machine-learning.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="apps.html">Tools &amp; Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="database-mirrors.html">Database Mirrors</a></li>
<li class="toctree-l1"><a class="reference internal" href="openmpi.html">OpenMPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="green-computing.html">Green Computing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data storage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data-storage.html">Data Storage &amp; Management Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="backups.html">Backups</a></li>
<li class="toctree-l1"><a class="reference internal" href="file-transfers.html">File Transfers</a></li>
<li class="toctree-l1"><a class="reference internal" href="samba.html">Samba Access</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contact-us.html">Contact Us</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring.html">Monitoring &amp; Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="linux-basics.html">Linux Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="tips.html">Tips &amp; Tricks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The legal stuff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="organizations.html">Supported Organisations</a></li>
<li class="toctree-l1"><a class="reference internal" href="sla.html">Service Level Agreement</a></li>
<li class="toctree-l1"><a class="reference internal" href="acceptable-use.html">Acceptable Use Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="gdpr.html">GDPR Privacy Notice</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Crop Diversity HPC Help</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Mask RCNN</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/cropgeeks/hpc-help/blob/master/ml-tut-maskrcnn.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mask-rcnn">
<h1>Mask RCNN<a class="headerlink" href="#mask-rcnn" title="Permalink to this headline"></a></h1>
<section id="building-an-anaconda-environment">
<h2>Building an Anaconda environment<a class="headerlink" href="#building-an-anaconda-environment" title="Permalink to this headline"></a></h2>
<p>First log into <code class="docutils literal notranslate"><span class="pre">gruffalo</span></code> in the standard way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="nd">@gruffalo</span><span class="o">.</span><span class="n">cropdiversity</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span>
</pre></div>
</div>
<p>Once connected create and activate a new Anaconda environment for the Mask R-CNN installation, specifically in <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">3.6.12</span></code> to avoid version conflicts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">maskrcnn_example</span> <span class="n">python</span><span class="o">=</span><span class="mf">3.6.12</span>

<span class="n">conda</span> <span class="n">activate</span> <span class="n">maskrcnn_example</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Python 3.6.12 is required for Tensorflow version 1.15. Alternatively, tutorials exist to update the model used to be compatible with more recent versions of both python and TensorFlow.</p>
</div>
<p>The implementation of Mask R-CNN used can be found on <a class="reference external" href="https://github.com/matterport/Mask_RCNN">GitHub</a>. Clone this repository into the <code class="docutils literal notranslate"><span class="pre">include</span></code> folder of the conda environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">conda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">include</span>

<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">matterport</span><span class="o">/</span><span class="n">Mask_RCNN</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>The required packages are listed in <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> in the new Mask_RCNN folder and could be installed from this, however, they automatically install the latest versions of each of the required packages which no longer work with the default model. Instead install the following packages using <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span></code>:</p>
<ul class="simple">
<li><p>numpy</p></li>
<li><p>scipy</p></li>
<li><p>Pillow</p></li>
<li><p>cython</p></li>
<li><p>matplotlib</p></li>
<li><p>scikit-image</p></li>
<li><p>tensorflow=1.15</p></li>
<li><p>tensorflow-gpu=1.15</p></li>
<li><p>keras=2.2.5</p></li>
<li><p>h5py</p></li>
<li><p>imgaug</p></li>
<li><p>IPython</p></li>
</ul>
<p>where <code class="docutils literal notranslate"><span class="pre">*=x.xx</span></code> specifies which version of the package to install. In <code class="docutils literal notranslate"><span class="pre">conda</span></code> this is marked by a single “=” whereas in <code class="docutils literal notranslate"><span class="pre">pip</span></code> it is denoted as “==”.
Alternatively, update the list in <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> with the above and use <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">-f</span> <span class="pre">requirements.txt</span></code> to install everything in a single command.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Installing from a single file will mean conda searches for a valid combination of all packages, unless versions are specified, which can take an excessive amount of time. It is reccomended to install each one-by-one allowing for individual conflicts to be resolved ad hoc.</p>
</div>
<p>Additionally, install “opencv-python” using <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code> as well as pycocotools using the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">philferriere</span><span class="o">/</span><span class="n">cocoapi</span><span class="o">.</span><span class="n">git</span><span class="c1">#subdirectory=PythonAPI</span>
</pre></div>
</div>
<p>Finally, if not already there, navigate to the install location and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
<p>If you encounter an error, make sure you are in the correct folder and have installed each of the required packages.</p>
</section>
<section id="configuring-port-forwarding-for-jupyter-notebooks">
<h2>Configuring port forwarding for jupyter notebooks<a class="headerlink" href="#configuring-port-forwarding-for-jupyter-notebooks" title="Permalink to this headline"></a></h2>
</section>
<section id="verifying-the-installation-and-performing-object-detection">
<h2>Verifying the installation and performing object detection<a class="headerlink" href="#verifying-the-installation-and-performing-object-detection" title="Permalink to this headline"></a></h2>
</section>
<section id="training-a-custom-dataset">
<h2>Training a custom dataset<a class="headerlink" href="#training-a-custom-dataset" title="Permalink to this headline"></a></h2>
<section id="sourcing-and-labelling-images">
<h3>Sourcing and Labelling Images<a class="headerlink" href="#sourcing-and-labelling-images" title="Permalink to this headline"></a></h3>
</section>
<section id="formatting-the-custom-dataset-for-input-into-mask-rcnn">
<h3>Formatting the custom Dataset for input into Mask RCNN<a class="headerlink" href="#formatting-the-custom-dataset-for-input-into-mask-rcnn" title="Permalink to this headline"></a></h3>
</section>
<section id="transfer-learning-vs-full-weight-training">
<h3>Transfer Learning vs Full Weight Training<a class="headerlink" href="#transfer-learning-vs-full-weight-training" title="Permalink to this headline"></a></h3>
</section>
<section id="tuning-a-custom-model">
<h3>Tuning a custom model<a class="headerlink" href="#tuning-a-custom-model" title="Permalink to this headline"></a></h3>
</section>
<section id="monitoring-training-progress">
<h3>Monitoring training progress<a class="headerlink" href="#monitoring-training-progress" title="Permalink to this headline"></a></h3>
<p>Training, especially from scratch on a deep network, takes hours and sometimes even days. Therefore, it is important to monitor and fine tune the training process and ensure the model is behaving.</p>
<p>Many tensorflow models include what are known as “callback” variables in order to monitor training. In the implementation of Mask RCNN we are using, custom callbacks can be added in the form of variables or functions on line 2346 of <code class="docutils literal notranslate"><span class="pre">model.py</span></code>.</p>
<section id="method-1-viewing-via-the-hpc-terminal">
<h4>Method 1: Viewing via the HPC Terminal<a class="headerlink" href="#method-1-viewing-via-the-hpc-terminal" title="Permalink to this headline"></a></h4>
<p>Most, if not all, models will have some basic training and validation monitoring built into the source. This is often in the form of printing updates directly to the command window such as the current training step and epoch as well as loss values.</p>
<p>In order to ensure the status remains visible, even in the event of a disconnection from gruffalo, the <code class="docutils literal notranslate"><span class="pre">screen</span></code> command can be used to create a persistent terminal that can be accessed.</p>
</section>
<section id="method-2-viewing-via-a-tensorboard-server">
<h4>Method 2: Viewing via a Tensorboard Server<a class="headerlink" href="#method-2-viewing-via-a-tensorboard-server" title="Permalink to this headline"></a></h4>
<p>Alternatively, callbacks can be viewed in Tensorboard, which watches the log files being generated during the training process and graphically displays the progress of these training values after each epoch.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unlike the terminal based feedback from the previous method which gave stepwise updates, these values are only updated after each successive epoch.</p>
</div>
<p>Run Tensorboard using the following, ensuring to provide arguments for both the watched port as well as a path to the logs directory inside your mask RCNN installation being watched:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">L</span> <span class="mi">12345</span><span class="p">:</span><span class="n">localhost</span><span class="p">:</span><span class="mi">12345</span> <span class="o">-</span><span class="n">J</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="nd">@gruffalo</span><span class="o">.</span><span class="n">cropdiversity</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="nd">@twiki</span>

<span class="n">tensorboard</span> <span class="o">--</span><span class="n">port</span> <span class="mi">12345</span> <span class="o">--</span><span class="n">logdir</span> <span class="o">../</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">directory</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the “logs” folder contains multiple subfolders, each of these will be superimposed onto the graphs shown in tensorboard which is useful for comparing the performance of multiple models or versions.</p>
</div>
</section>
</section>
</section>
<section id="inference-testing">
<h2>Inference (Testing)<a class="headerlink" href="#inference-testing" title="Permalink to this headline"></a></h2>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022 Information &amp; Computational Sciences, The James Hutton Institute.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>